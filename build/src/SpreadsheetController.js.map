{"version":3,"sources":["../../develop/src/SpreadsheetController.js"],"names":[],"mappings":"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","file":"SpreadsheetController.js","sourcesContent":["import Parsers from './Parsers';\r\nvar config = require('../../config');\r\nvar GoogleSpreadsheet = require(\"google-spreadsheet\");\r\nvar Promise = require('native-or-bluebird');\r\n\r\nclass SpreadsheetController\r\n{\r\n    constructor(id, name, onReady)\r\n    {\r\n        this._incompatibleTags = ['_links', 'save', 'del', 'content', '_xml'];\r\n\r\n        this.sheet = new GoogleSpreadsheet(id);\r\n        this.sheet.useServiceAccountAuth(config.googleauth, this.init.bind(this, onReady));\r\n        this.name = name;\r\n\r\n    }\r\n\r\n    init(onReady) {\r\n        this.sheet.getInfo((err, sheet_info) => {\r\n            this.data = sheet_info;\r\n            onReady();\r\n        });\r\n    }\r\n\r\n    getAll(clean = true) {\r\n\r\n        return new Promise((resolve, reject)=>\r\n        {\r\n            let iterables = this.data.worksheets.map((element, index) => {\r\n                return this.getRow(element, clean);\r\n            });\r\n\r\n            Promise.all(iterables).then(\r\n                results => {\r\n                    //results is an array of objects, each object being a worksheet\r\n                    //now we merge all in one object\r\n                    let title = typeof this.name === 'undefined' ? this.data.title : this.name;\r\n                    resolve({title: title, results: Object.assign(...results)});\r\n                },\r\n                error => {\r\n                    reject(error);\r\n                });\r\n        });\r\n    }\r\n\r\n    getRow(element, clean) {\r\n        return new Promise((resolve, reject) => {\r\n            element.getRows((err, rows)=> {\r\n                if (err) {\r\n                    reject(err);\r\n                }\r\n                else {\r\n                    resolve({[element.title]: this.filter(rows, clean)});\r\n                }\r\n            });\r\n        })\r\n    }\r\n\r\n    filter(rows, clean)\r\n    {\r\n        let filtered = [];\r\n        let filteredRow = {};\r\n        let locales = {};\r\n\r\n        for (var i = 0; i < rows.length; i++)\r\n        {\r\n            filteredRow = {};\r\n\r\n            for (var key in rows[i])\r\n            {\r\n                if (rows[i].hasOwnProperty(key) && this._incompatibleTags.indexOf(key) === -1)\r\n                {\r\n                    let filteredKey;\r\n                    let locale;\r\n                    let value =  clean ? Parsers.cleanSpaces(rows[i][key]) : rows[i][key];\r\n\r\n                    //Check if property is localized\r\n                    if(key.indexOf('-locale-') === -1)\r\n                    {\r\n                        filteredKey = Parsers.camelize(Parsers.cleanSpaces(key));\r\n                        filteredRow[filteredKey] = value;\r\n                    }\r\n                    else\r\n                    {\r\n                        filteredKey = Parsers.camelize(Parsers.cleanLocale(Parsers.cleanSpaces(key)));\r\n                        locale = this.extractLocale(key);\r\n                        if(!locales.hasOwnProperty(locale))\r\n                        {\r\n                            locales[locale] = {[filteredKey]: []};\r\n                        }\r\n\r\n                        locales[locale][filteredKey].push(value);\r\n                    }\r\n\r\n                    //filteredRow[filteredKey] = clean ? Parsers.cleanSpaces(rows[i][key]) : rows[i][key];\r\n                }\r\n            }\r\n\r\n            filtered.push(filteredRow);\r\n        }\r\n\r\n        return {rows: filtered, locales};\r\n    }\r\n\r\n    extractLocale(propertyName)\r\n    {\r\n        //Check if locale is present property name\r\n        return propertyName.split('-').pop();\r\n    }\r\n\r\n    getCellsByWorksheetId(worksheetId, onReady) {\r\n        for (var i = 0; i < this.data.worksheets.length; i++) {\r\n            if (this.data.worksheets[i].title === worksheetId) {\r\n                this.data.worksheets[i].getCells(this.data.worksheets[i].id, function (off, data) {\r\n                    onReady(data);\r\n                });\r\n                return;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch spreadsheet\r\n * @param spId\r\n * @param cleanSpaces\r\n * @returns {exports|module.exports}\r\n */\r\nexport function fecthSpreadsheet(spId, name, cleanSpaces = true) {\r\n\r\n    console.log(`Fetching data from ${spId}`.bgBlue.white);\r\n    return new Promise((resolve, reject) => {\r\n        let spreadsheet = new SpreadsheetController(spId, name, ()=> {\r\n            spreadsheet.getAll(cleanSpaces).then(data => resolve(data), error => reject(error));\r\n        });\r\n    });\r\n};\r\n\r\n/**\r\n * Create a list of promises for spreadsheets\r\n * @param list\r\n * @returns {Array}\r\n */\r\nexport function loadSpreadsheets(list) {\r\n\r\n    let metadata = [];\r\n    list.forEach(spreadsheet => {\r\n      metadata.push(fecthSpreadsheet(spreadsheet.id, spreadsheet.name, JSON.parse(spreadsheet.cleanSpaces)));\r\n    });\r\n\r\n    return metadata;\r\n};\r\n\r\nexport default SpreadsheetController;\r\n\r\n"]}